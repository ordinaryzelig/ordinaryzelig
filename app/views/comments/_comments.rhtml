<% # add comment. -%>
<% if logged_in_user -%>
  <%= render(:partial => "comments/comment", :locals => {:entity => entity}) %>
<% else -%>
  <%= link_to("login", :controller => "login", :action => "login") %> to post comments
<% end -%>

<% # comments. %>
<div id="comments">
  <% entity.root_comments.each do |root_comment| -%>
    <%= render(:partial => "comments/comment", :locals => {:comment => root_comment}) %>
  <% end -%>
</div>